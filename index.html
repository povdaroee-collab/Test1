<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីសុំច្បាប់ - ឧស្សាហកម្មឌីជីថល</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Khmer -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            updateDoc,
            deleteDoc,
            getDoc,
            collection, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp,
            Timestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firestore debug logging
        setLogLevel('debug'); 

        // --- Hard-coded Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDjr_Ha2RxOWEumjEeSdluIW3JmyM76mVk",
            authDomain: "dipermisstion.firebaseapp.com",
            projectId: "dipermisstion",
            storageBucket: "dipermisstion.firebasestorage.app",
            messagingSenderId: "512999406057",
            appId: "1:512999406057:web:953a281ab9dde7a9a0f378", 
            measurementId: "G-KDPHXZ7H4B"
        };
        // --- End of Hard-coded Config ---

        // --- Global State & Element References ---
        let db, auth, userId;
        let historyUnsubscribe = null; 
        let outHistoryUnsubscribe = null;
        let allUsersData = []; 
        let currentUser = null; 
        let selectedUserId = null; 
        let faceScanInterval = null; 
        let userReferenceDescriptor = null;
        let currentReturnRequestId = null;

        // --- Google Sheet Config ---
        const SHEET_ID = '1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc';
        const SHEET_NAME = 'បញ្ជឺឈ្មោះរួម';
        const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tq=${encodeURIComponent('SELECT E, L, AA, N, G, S WHERE E IS NOT NULL OFFSET 0')}`;

        // --- Telegram Config ---
        const BOT_TOKEN = '8284240201:AAEDRGHDcuoQAhkWk7km6I-9csZNbReOPHw';
        const CHAT_ID = '1487065922';
        
        // --- Firestore Collection Path ---
        let leaveRequestsCollectionPath; 
        let outRequestsCollectionPath;

        // --- Location Config ---
        const allowedAreaCoords = [
            [11.417052769150015, 104.76508285291308],
            [11.417130005964497, 104.76457396198742],
            [11.413876386899489, 104.76320488118378],
            [11.41373800267192, 104.76361527709159]
        ];

        const LOCATION_FAILURE_MESSAGE = "ការបញ្ជាក់ចូលមកវិញ បរាជ័យ។ \n\nប្រហែលទូរស័ព្ទអ្នកមានបញ្ហា ការកំណត់បើ Live Location ដូច្នោះអ្នកមានជម្រើសមួយទៀតគឺអ្នកអាចទៅបញ្ជាក់ដោយផ្ទាល់នៅការិយាល័យអគារ B ជាមួយក្រុមការងារលោកគ្រូ ដារ៉ូ។";

        // --- Element References (Will be assigned in DOMContentLoaded) ---
        let userSearchInput, userDropdown, userSearchError, scanFaceBtn, modelStatusEl, 
            faceScanModal, video, scanStatusEl, scanDebugEl, cancelScanBtn, 
            loginFormContainer, inAppWarning, dataLoadingIndicator, rememberMeCheckbox, 
            mainAppContainer, homeUserName, loginPage, bottomNav, 
            userPhotoEl, userNameEl, userIdEl, userGenderEl, userGroupEl, userDepartmentEl, 
            logoutBtn, navButtons, pages, mainContent, 
            requestLeavePage, openLeaveRequestBtn, cancelLeaveRequestBtn, submitLeaveRequestBtn, 
            leaveDurationSearchInput, leaveDurationDropdownEl, leaveSingleDateContainer, leaveDateRangeContainer, 
            leaveSingleDateInput, leaveStartDateInput, leaveEndDateInput, leaveRequestErrorEl, leaveRequestLoadingEl, 
            leaveReasonSearchInput, leaveReasonDropdownEl,
            historyContainer, historyPlaceholder,
            criticalErrorDisplay,
            historyTabLeave, historyTabOut, historyContainerLeave, historyContainerOut,
            historyPlaceholderLeave, historyPlaceholderOut,
            // Edit Modal Elements
            editModal, editModalTitle, editForm, editRequestId, 
            editDurationSearch, editDurationDropdown, 
            editSingleDateContainer, editLeaveDateSingle, 
            editDateRangeContainer, editLeaveDateStart, editLeaveDateEnd,
            editReasonSearch, editReasonDropdown,
            editErrorEl, editLoadingEl, submitEditBtn, cancelEditBtn,
            // Delete Modal Elements
            deleteModal, deleteConfirmBtn, cancelDeleteBtn, deleteRequestId, deleteCollectionType,
            // Out Request Elements
            openOutRequestBtn, requestOutPage, cancelOutRequestBtn, submitOutRequestBtn,
            outRequestErrorEl, outRequestLoadingEl,
            outDurationSearchInput, outDurationDropdownEl, outReasonSearchInput, outReasonDropdownEl,
            outDateInput,
            // Return Scan Modal Elements
            returnScanModal, returnVideo, returnScanStatusEl, returnScanDebugEl, cancelReturnScanBtn,
            // <<< ថ្មី: Custom Alert Modal Elements
            customAlertModal, customAlertTitle, customAlertMessage,
            customAlertOkBtn, customAlertIconWarning, customAlertIconSuccess;


        // --- Duration/Reason Constants ---
        const leaveDurations = [
            "មួយព្រឹក", "មួយរសៀល", "មួយយប់", "មួយថ្ងៃ", "មួយថ្ងៃកន្លះ", "ពីរថ្ងៃ", "ពីរថ្ងៃកន្លះ",
            "បីថ្ងៃ", "បីថ្ងៃកន្លះ", "បួនថ្ងៃ", "បួនថ្ងៃកន្លះ", "ប្រាំថ្ងៃ", "ប្រាំថ្ងៃកន្លះ",
            "ប្រាំមួយថ្ងៃ", "ប្រាំមួយថ្ងៃកន្លះ", "ប្រាំពីរថ្ងៃ"
        ];
        const leaveDurationItems = leaveDurations.map(d => ({ text: d, value: d }));
        const leaveReasons = ["ឈឺក្បាល", "ចុកពោះ", "គ្រុនក្ដៅ", "ផ្ដាសាយ"];
        const leaveReasonItems = leaveReasons.map(r => ({ text: r, value: r }));
        const singleDayLeaveDurations = ["មួយព្រឹក", "មួយរសៀល", "មួយយប់", "មួយថ្ងៃ"];

        const outDurations = ["មួយព្រឹក", "មួយរសៀល", "មួយថ្ងៃ"];
        const outDurationItems = outDurations.map(d => ({ text: d, value: d }));
        const outReasons = ["ទៅផ្សារ", "ទៅកាត់សក់", "ទៅភ្នំពេញ", "ទៅពេទ្យ", "ទៅយកអីវ៉ាន់"];
        const outReasonItems = outReasons.map(r => ({ text: r, value: r }));

        // --- Date Helper Functions ---
        function getTodayString(format = 'yyyy-mm-dd') {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            
            if (format === 'dd/mm/yyyy') {
                return `${dd}/${mm}/${yyyy}`;
            }
            return `${yyyy}-${mm}-${dd}`; // Default format for input[type=date]
        }
        
        function formatDbDateToInput(dbDate) {
            // Assumes dbDate is dd/mm/yyyy
            if (!dbDate || dbDate.split('/').length !== 3) return getTodayString(); // yyyy-mm-dd
            const parts = dbDate.split('/');
            return `${parts[2]}-${parts[1]}-${parts[0]}`; // yyyy-mm-dd
        }
        
        function formatInputDateToDb(inputDate) {
            // Assumes inputDate is yyyy-mm-dd
            if (!inputDate || inputDate.split('-').length !== 3) return getTodayString('dd/mm/yyyy');
            const parts = inputDate.split('-');
            return `${parts[2]}/${parts[1]
                }/${parts[0]}`; // dd/mm/yyyy
        }

        function addDays(startDateStr, days) {
            try {
                const date = new Date(startDateStr); // yyyy-mm-dd
                if (isNaN(date.getTime())) return getTodayString(); // yyyy-mm-dd
                date.setDate(date.getDate() + Math.ceil(days) - 1); 
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            } catch (e) {
                console.error("Error in addDays:", e);
                return getTodayString();
            }
        }
        // --- End of Date Helpers ---

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- Assign Element References ---
            userSearchInput = document.getElementById('user-search');
            userDropdown = document.getElementById('user-dropdown');
            userSearchError = document.getElementById('user-search-error');
            scanFaceBtn = document.getElementById('scan-face-btn');
            modelStatusEl = document.getElementById('model-status');
            faceScanModal = document.getElementById('face-scan-modal');
            video = document.getElementById('video');
            scanStatusEl = document.getElementById('scan-status');
            scanDebugEl = document.getElementById('scan-debug');
            cancelScanBtn = document.getElementById('cancel-scan-btn');
            loginFormContainer = document.getElementById('login-form-container');
            inAppWarning = document.getElementById('in-app-warning');
            dataLoadingIndicator = document.getElementById('data-loading-indicator');
            rememberMeCheckbox = document.getElementById('remember-me');
            mainAppContainer = document.getElementById('main-app-container');
            homeUserName = document.getElementById('home-user-name');
            loginPage = document.getElementById('page-login');
            bottomNav = document.getElementById('bottom-navigation');
            userPhotoEl = document.getElementById('user-photo');
            userNameEl = document.getElementById('user-name');
            userIdEl = document.getElementById('user-id');
            userGenderEl = document.getElementById('user-gender');
            userGroupEl = document.getElementById('user-group');
            userDepartmentEl = document.getElementById('user-department');
            logoutBtn = document.getElementById('logout-btn');
            navButtons = document.querySelectorAll('.nav-btn');
            pages = ['page-home', 'page-history', 'page-account', 'page-help', 'page-request-leave', 'page-request-out'];
            mainContent = document.getElementById('main-content');
            criticalErrorDisplay = document.getElementById('critical-error-display');
            
            // Leave Request Form
            requestLeavePage = document.getElementById('page-request-leave');
            openLeaveRequestBtn = document.getElementById('open-leave-request-btn');
            cancelLeaveRequestBtn = document.getElementById('cancel-leave-request-btn');
            submitLeaveRequestBtn = document.getElementById('submit-leave-request-btn');
            leaveDurationSearchInput = document.getElementById('leave-duration-search');
            leaveDurationDropdownEl = document.getElementById('leave-duration-dropdown');
            leaveSingleDateContainer = document.getElementById('leave-single-date-container');
            leaveDateRangeContainer = document.getElementById('leave-date-range-container');
            leaveSingleDateInput = document.getElementById('leave-date-single');
            leaveStartDateInput = document.getElementById('leave-date-start');
            leaveEndDateInput = document.getElementById('leave-date-end');
            leaveRequestErrorEl = document.getElementById('leave-request-error');
            leaveRequestLoadingEl = document.getElementById('leave-request-loading');
            leaveReasonSearchInput = document.getElementById('leave-reason-search');
            leaveReasonDropdownEl = document.getElementById('leave-reason-dropdown');

            // Out Request Form
            openOutRequestBtn = document.getElementById('open-out-request-btn');
            requestOutPage = document.getElementById('page-request-out');
            cancelOutRequestBtn = document.getElementById('cancel-out-request-btn');
            submitOutRequestBtn = document.getElementById('submit-out-request-btn');
            outRequestErrorEl = document.getElementById('out-request-error');
            outRequestLoadingEl = document.getElementById('out-request-loading');
            outDurationSearchInput = document.getElementById('out-duration-search');
            outDurationDropdownEl = document.getElementById('out-duration-dropdown');
            outReasonSearchInput = document.getElementById('out-reason-search');
            outReasonDropdownEl = document.getElementById('out-reason-dropdown');
            outDateInput = document.getElementById('out-date-single');

            // History Page
            historyContainer = document.getElementById('history-container'); // Main container
            historyPlaceholder = document.getElementById('history-placeholder');
            historyTabLeave = document.getElementById('history-tab-leave');
            historyTabOut = document.getElementById('history-tab-out');
            historyContainerLeave = document.getElementById('history-container-leave');
            historyContainerOut = document.getElementById('history-container-out');
            historyPlaceholderLeave = document.getElementById('history-placeholder-leave');
            historyPlaceholderOut = document.getElementById('history-placeholder-out');
            
            // Edit Modal
            editModal = document.getElementById('edit-modal');
            editModalTitle = document.getElementById('edit-modal-title');
            editForm = document.getElementById('edit-form');
            editRequestId = document.getElementById('edit-request-id');
            editDurationSearch = document.getElementById('edit-duration-search');
            editDurationDropdown = document.getElementById('edit-duration-dropdown');
            editSingleDateContainer = document.getElementById('edit-single-date-container');
            editLeaveDateSingle = document.getElementById('edit-leave-date-single');
            editDateRangeContainer = document.getElementById('edit-date-range-container');
            editLeaveDateStart = document.getElementById('edit-leave-date-start');
            editLeaveDateEnd = document.getElementById('edit-leave-date-end');
            editReasonSearch = document.getElementById('edit-reason-search');
            editReasonDropdown = document.getElementById('edit-reason-dropdown');
            editErrorEl = document.getElementById('edit-error');
            editLoadingEl = document.getElementById('edit-loading');
            submitEditBtn = document.getElementById('submit-edit-btn');
            cancelEditBtn = document.getElementById('cancel-edit-btn');

            // Delete Modal
            deleteModal = document.getElementById('delete-modal');
            deleteConfirmBtn = document.getElementById('delete-confirm-btn');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            deleteRequestId = document.getElementById('delete-request-id');
            deleteCollectionType = document.getElementById('delete-collection-type');

            // Return Scan Modal
            returnScanModal = document.getElementById('return-scan-modal');
            returnVideo = document.getElementById('return-video');
            returnScanStatusEl = document.getElementById('return-scan-status');
            returnScanDebugEl = document.getElementById('return-scan-debug');
            cancelReturnScanBtn = document.getElementById('cancel-return-scan-btn');

            // <<< ថ្មី: Custom Alert Modal
            customAlertModal = document.getElementById('custom-alert-modal');
            customAlertTitle = document.getElementById('custom-alert-title');
            customAlertMessage = document.getElementById('custom-alert-message');
            customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
            customAlertIconWarning = document.getElementById('custom-alert-icon-warning');
            customAlertIconSuccess = document.getElementById('custom-alert-icon-success');

            // <<< ថ្មី: Add listener for Custom Alert
            if (customAlertOkBtn) {
                customAlertOkBtn.addEventListener('click', hideCustomAlert);
            }

            // --- Firebase Initialization ---
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                leaveRequestsCollectionPath = `/artifacts/${canvasAppId}/public/data/leave_requests`;
                outRequestsCollectionPath = `/artifacts/${canvasAppId}/public/data/out_requests`;
                console.log("Using Firestore Leave Path:", leaveRequestsCollectionPath);
                console.log("Using Firestore Out Path:", outRequestsCollectionPath);

                // --- Firebase Authentication ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Firebase Auth state changed. User UID:", user.uid);
                        userId = user.uid; // Firebase Auth UID

                        // --- Check browser and load models FIRST ---
                        function isClient() {
                            const ua = navigator.userAgent || navigator.vendor || window.opera;
                            return (
                                (ua.indexOf('FBAN') > -1) || (ua.indexOf('FBAV') > -1) ||
                                (ua.indexOf('Twitter') > -1) || (ua.indexOf('Telegram') > -1) ||
                                (ua.indexOf('WebView') > -1) || (ua.indexOf('wv') > -1)
                            );
                        }

                        if (isClient()) {
                            console.log("Detected In-App Browser.");
                            if (inAppWarning) inAppWarning.classList.remove('hidden');
                            if (modelStatusEl) modelStatusEl.textContent = 'សូមបើកក្នុង Browser ពេញលេញ';
                            if (dataLoadingIndicator) dataLoadingIndicator.classList.add('hidden');
                            // Do not proceed to load models or data
                        } else {
                            console.log("Detected Full Browser.");
                            if (inAppWarning) inAppWarning.classList.add('hidden');
                            
                            // Load models immediately
                            if (typeof faceapi !== 'undefined') {
                                if (scanFaceBtn) scanFaceBtn.disabled = true; 
                                loadFaceApiModels(); // Call this immediately
                            } else {
                                console.error("Face-API.js មិនអាចទាញយកបានត្រឹមត្រូវទេ។");
                                if (modelStatusEl) modelStatusEl.textContent = 'Error: មិនអាចទាញយក Library ស្កេនមុខបាន';
                            }
                            // --- End of new logic ---

                            const rememberedUser = localStorage.getItem('leaveAppUser');
                            if (rememberedUser) {
                                try {
                                    const parsedUser = JSON.parse(rememberedUser);
                                    if (parsedUser && parsedUser.id) { 
                                        console.log("Found remembered user:", parsedUser.id);
                                        currentUser = parsedUser; 
                                        showLoggedInState(parsedUser); // This will now work, models are loading
                                        fetchUsers(); // Fetch in background
                                        return; 
                                    }
                                } catch (e) {
                                    localStorage.removeItem('leaveAppUser'); 
                                }
                            }
                            console.log("No remembered user found, starting normal app flow.");
                            initializeAppFlow(); // This will now only fetch users
                        }

                    } else {
                        console.log("Firebase Auth: No user signed in. Attempting anonymous sign-in...");
                        signInAnonymously(auth).catch(anonError => {
                             console.error("Error during automatic anonymous sign-in attempt:", anonError);
                             if (criticalErrorDisplay) {
                                 criticalErrorDisplay.classList.remove('hidden');
                                 criticalErrorDisplay.textContent = `Critical Error: មិនអាច Sign In បានទេ។ ${anonError.message}។ សូម Refresh ម្ដងទៀត។`;
                             }
                        });
                    }
                });


                // --- Initial Anonymous Sign-In ---
                try {
                    console.log("Attempting initial Anonymous Sign-In...");
                    await signInAnonymously(auth);
                    console.log("Firebase Auth: Initial Anonymous Sign-In successful (or already signed in).");
                } catch (e) {
                    console.error("Initial Anonymous Sign-In Error:", e);
                    if (e.code === 'auth/operation-not-allowed') {
                        throw new Error("សូមបើក 'Anonymous' sign-in នៅក្នុង Firebase Console។");
                    }
                    throw new Error(`Firebase Sign-In Error: ${e.message}`);
                }

            } catch (e) {
                console.error("Firebase Initialization/Auth Error:", e);
                if(criticalErrorDisplay) {
                    criticalErrorDisplay.classList.remove('hidden');
                    criticalErrorDisplay.textContent = `Critical Error: មិនអាចតភ្ជាប់ Firebase បានទេ។ ${e.message}។ សូម Refresh ម្ដងទៀត។`;
                }
                if(loginPage) loginPage.classList.add('hidden'); // Hide login form
            }

            // --- Main App Logic (to be called after auth is confirmed) ---
            function initializeAppFlow() {
                console.log("initializeAppFlow called (for non-remembered user).");
                console.log("Fetching users for initial login...");
                if (dataLoadingIndicator) dataLoadingIndicator.classList.remove('hidden');
                fetchUsers();
            }
            
            // --- Google Sheet Data Fetching ---
            async function fetchUsers() {
                console.log("Fetching users from Google Sheet...");
                try {
                    const response = await fetch(GVIZ_URL);
                    if (!response.ok) throw new Error(`Google Sheet fetch failed: ${response.status}`);
                    const text = await response.text();
                    const match = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
                     if (!match || !match[1]) throw new Error("ទម្រង់ការឆ្លើយតបពី Google Sheet មិនត្រឹមត្រូវ");
                    const json = JSON.parse(match[1]);
                    
                    if (json.table && json.table.rows && json.table.rows.length > 0) {
                        allUsersData = json.table.rows.map(row => ({
                            id: row.c && row.c[0] ? row.c[0].v : null,
                            name: row.c && row.c[1] ? row.c[1].v : null,
                            photo: row.c && row.c[2] ? row.c[2].v : null,
                            gender: row.c && row.c[3] ? row.c[3].v : null,
                            group: row.c && row.c[4] ? row.c[4].v : null,
                            department: row.c && row.c[5] ? row.c[5].v : null,
                        }));
                        console.log(`Fetched ${allUsersData.length} users.`);
                        populateUserDropdown(allUsersData, 'user-search', 'user-dropdown', (id) => {
                            selectedUserId = id;
                            if (scanFaceBtn) scanFaceBtn.disabled = (id === null || !modelStatusEl || modelStatusEl.textContent !== 'Model ស្កេនមុខបានទាញយករួចរាល់');
                            console.log("Selected User ID:", selectedUserId);
                        });
                        
                        if (dataLoadingIndicator) dataLoadingIndicator.classList.add('hidden');
                        if (loginFormContainer) loginFormContainer.classList.remove('hidden');
                    } else {
                        throw new Error("រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់");
                    }
                } catch (error) {
                    console.error("Error ពេលទាញយកទិន្នន័យ Google Sheet:", error);
                    if (dataLoadingIndicator) {
                        dataLoadingIndicator.innerHTML = `<p class="text-red-600 font-semibold">Error: មិនអាចទាញយកទិន្នន័យបាន</p><p class="text-gray-600 text-sm mt-1">សូមពិនិត្យអ៊ីនធឺណិត និង Refresh ម្ដងទៀត។</p>`;
                        dataLoadingIndicator.classList.remove('hidden'); 
                    }
                }
            }

            // --- Reusable Searchable Dropdown Logic ---
            let selectedLeaveDuration = null;
            let selectedLeaveReason = null;
            let selectedOutDuration = null;
            let selectedOutReason = null;

            function setupSearchableDropdown(inputId, dropdownId, items, onSelectCallback, allowCustom = false) {
                const searchInput = document.getElementById(inputId);
                const dropdown = document.getElementById(dropdownId);
                
                if (!searchInput || !dropdown) {
                     console.error(`Dropdown elements not found: inputId=${inputId}, dropdownId=${dropdownId}`);
                     return;
                 }

                function populateDropdown(filter = '') {
                    dropdown.innerHTML = '';
                    const filteredItems = items.filter(item => item.text && item.text.toLowerCase().includes(filter.toLowerCase())); 
                    
                    if (filteredItems.length === 0 && !allowCustom) {
                         dropdown.classList.add('hidden');
                         return;
                     }

                    filteredItems.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.textContent = item.text;
                        itemEl.dataset.value = item.value;
                        itemEl.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                        
                        itemEl.addEventListener('mousedown', (e) => {
                            e.preventDefault(); 
                            searchInput.value = item.text;
                            dropdown.classList.add('hidden');
                            if (onSelectCallback) onSelectCallback(item.value);
                            console.log(`Selected dropdown item: ${item.text} (value: ${item.value})`);
                        });
                        dropdown.appendChild(itemEl);
                    });
                    dropdown.classList.remove('hidden');
                }

                searchInput.addEventListener('input', () => {
                    const currentValue = searchInput.value;
                    populateDropdown(currentValue);
                    
                    const exactMatch = items.find(item => item.text === currentValue);
                    const selection = exactMatch ? exactMatch.value : (allowCustom ? currentValue : null);
                    if (onSelectCallback) onSelectCallback(selection);
                });

                searchInput.addEventListener('focus', () => {
                     populateDropdown(searchInput.value);
                });

                searchInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        dropdown.classList.add('hidden');
                        const currentValue = searchInput.value;
                        const validItem = items.find(item => item.text === currentValue);
                        
                        if (validItem) {
                            if (onSelectCallback) onSelectCallback(validItem.value);
                        } else if (allowCustom && currentValue.trim() !== '') {
                            if (onSelectCallback) onSelectCallback(currentValue);
                         } else { // Not valid item, not custom
                             console.log(`Invalid selection on ${inputId}: ${currentValue}`);
                             if (onSelectCallback) onSelectCallback(null);
                         }
                    }, 150);
                });
            }

            function populateUserDropdown(users, inputId, dropdownId, onSelectCallback) {
                const userItems = users
                    .filter(user => user.id && user.name)
                    .map(user => ({ text: `${user.id} - ${user.name}`, value: user.id }));
                setupSearchableDropdown(inputId, dropdownId, userItems, onSelectCallback, false);
            }

            // --- Face Scan Logic ---
            async function loadFaceApiModels() {
                if (!modelStatusEl) return;
                try {
                    console.log("Loading face-api models...");
                    modelStatusEl.textContent = 'កំពុងទាញយក Model ស្កេនមុខ...';
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                    ]);
                    modelStatusEl.textContent = 'Model ស្កេនមុខបានទាញយករួចរាល់';
                    console.log("Face-api models loaded successfully.");
                    if (scanFaceBtn) scanFaceBtn.disabled = (selectedUserId === null); 
                } catch (error) {
                    console.error("Error ពេលទាញយក Model របស់ face-api:", error);
                    modelStatusEl.textContent = 'Error: មិនអាចទាញយក Model បាន';
                }
            }

            async function getReferenceDescriptor(userPhotoUrl) {
                if (userReferenceDescriptor) {
                    console.log("Using cached reference descriptor.");
                    return userReferenceDescriptor;
                }

                if (!userPhotoUrl) throw new Error("Missing user photo URL");

                console.log("Fetching and computing new reference descriptor...");
                let referenceImage;
                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous'; 
                    img.src = userPhotoUrl;
                    await new Promise((resolve, reject) => {
                        img.onload = () => resolve();
                        img.onerror = (err) => reject(new Error('Failed to fetch (មិនអាចទាញយករូបថតយោងបាន)។ សូមប្រាកដថា Link រូបថតត្រឹមត្រូវ។')); 
                    });
                    referenceImage = img;
                } catch (fetchError) {
                    throw fetchError; 
                }
                
                let referenceDetection;
                try {
                    // <<< នេះជាការកែប្រែពីមុន
                    const options = new faceapi.TinyFaceDetectorOptions(); 
                    referenceDetection = await faceapi.detectSingleFace(referenceImage, options).withFaceLandmarks(true).withFaceDescriptor();
                    
                    if (!referenceDetection) throw new Error('រកមិនឃើញមុខនៅក្នុងរូបថតយោង');
                } catch (descriptorError) {
                    console.error("Descriptor Error:", descriptorError);
                    throw new Error('មិនអាចវិភាគមុខពីរូបថតយោងបានទេ (រូបថតអាចមិនច្បាស់)។');
                }

                userReferenceDescriptor = referenceDetection.descriptor; // Cache it
                return userReferenceDescriptor;
            }


            async function startFaceScan() {
                console.log("startFaceScan called.");
                if (!selectedUserId) {
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("Error", "សូមជ្រើសរើសអត្តលេខរបស់អ្នកជាមុនសិន");
                    return;
                }
                
                const user = allUsersData.find(u => u.id === selectedUserId);
                if (!user || !user.photo) {
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("Error", "មិនអាចទាញយករូបថតយោងរបស់អ្នកបានទេ។ សូមទាក់ទង IT Support។");
                    return;
                }

                if (faceScanModal) faceScanModal.classList.remove('hidden');
                if (scanStatusEl) scanStatusEl.textContent = 'កំពុងព្យាយាមបើកកាមេរ៉ា...';

                try {
                    // 1. Compute reference descriptor
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងវិភាគរូបថតយោង...';
                    const referenceDescriptor = await getReferenceDescriptor(user.photo);

                    // 2. Start video stream
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងស្នើសុំបើកកាមេរ៉ា...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    if (video) video.srcObject = stream;
                    if (scanStatusEl) scanStatusEl.textContent = 'សូមដាក់មុខរបស់អ្នកឲ្យចំកាមេរ៉ា';

                    // 3. Start detection interval
                    if (faceScanInterval) clearInterval(faceScanInterval); 
                    faceScanInterval = setInterval(async () => {
                        if (!video || video.readyState < 3) return; 

                        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true).withFaceDescriptor();
                        
                        if (detections) {
                            if (scanStatusEl) scanStatusEl.textContent = 'រកឃើញផ្ទៃមុខ! កំពុងផ្ទៀងផ្ទាត់...';
                            const distance = faceapi.euclideanDistance(referenceDescriptor, detections.descriptor);
                            const similarity = (1 - distance).toFixed(2);
                            const threshold = 0.55; // Matching threshold
                            if (scanDebugEl) scanDebugEl.textContent = `ភាពស្រដៀងគ្នា: ${similarity} (ត្រូវតែ > ${1-threshold})`;

                            if (distance < threshold) { 
                                if (scanStatusEl) scanStatusEl.textContent = 'ផ្ទៀងផ្ទាត់ជោគជ័យ!';
                                stopFaceScan(); 
                                loginUser(selectedUserId);
                                
                                setTimeout(() => {
                                    if (faceScanModal) faceScanModal.classList.add('hidden');
                                }, 1000);
                            } else {
                                if (scanStatusEl) scanStatusEl.textContent = 'មុខមិនត្រឹមត្រូវ... សូមព្យាយាមម្តងទៀត';
                            }
                        } else {
                            if (scanStatusEl) scanStatusEl.textContent = 'រកមិនឃើញផ្ទៃមុខ...';
                            if (scanDebugEl) scanDebugEl.textContent = '';
                        }
                    }, 500);

                } catch (error) {
                    console.error("Error during face scan process:", error);
                    if (scanStatusEl) scanStatusEl.textContent = `Error: ${error.message}`;
                    stopFaceScan(); 
                     setTimeout(() => { 
                         if (faceScanModal) faceScanModal.classList.add('hidden'); 
                         // <<< កែប្រែ: ប្រើ showCustomAlert
                         showCustomAlert("បញ្ហាស្កេនមុខ", `មានបញ្ហា៖\n${error.message}\nសូមប្រាកដថាអ្នកបានអនុញ្ញាតឲ្យប្រើកាមេរ៉ា។`);
                     }, 1500); 
                }
            }

            function stopFaceScan() {
                if (faceScanInterval) clearInterval(faceScanInterval);
                faceScanInterval = null;
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
            }

            if (scanFaceBtn) scanFaceBtn.addEventListener('click', startFaceScan);
            if (cancelScanBtn) cancelScanBtn.addEventListener('click', () => {
                stopFaceScan();
                if (faceScanModal) faceScanModal.classList.add('hidden');
            });

            // --- App Navigation & State Logic ---
            function loginUser(userIdToLogin) {
                 const user = allUsersData.find(u => u.id === userIdToLogin);
                 if (!user) {
                     // <<< កែប្រែ: ប្រើ showCustomAlert
                     showCustomAlert("Login Error", "មានបញ្ហា Login: រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់");
                     return;
                 }
                if (rememberMeCheckbox && rememberMeCheckbox.checked) {
                    localStorage.setItem('leaveAppUser', JSON.stringify(user));
                } else {
                    localStorage.removeItem('leaveAppUser');
                }
                showLoggedInState(user);
            }
            
            function logout() {
                currentUser = null;
                userReferenceDescriptor = null;
                localStorage.removeItem('leaveAppUser'); 
                if (loginPage) loginPage.classList.remove('hidden');
                if (mainAppContainer) mainAppContainer.classList.add('hidden');
                
                // Clear account details
                if (userPhotoEl) userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=User';
                if (userNameEl) userNameEl.textContent = '...';
                if (userIdEl) userIdEl.textContent = '...';
                
                if (userSearchInput) userSearchInput.value = '';
                selectedUserId = null;
                if (scanFaceBtn) scanFaceBtn.disabled = true;

                if (historyUnsubscribe) historyUnsubscribe();
                if (outHistoryUnsubscribe) outHistoryUnsubscribe();
                historyUnsubscribe = null;
                outHistoryUnsubscribe = null;
                
                signInAnonymously(auth).catch(err => console.error("Error signing in anonymously after logout:", err));
            }
            
            function showLoggedInState(user) {
                currentUser = user;
                userReferenceDescriptor = null;
                populateAccountPage(user);
                if (homeUserName) homeUserName.textContent = user.name || '...';
                if (loginPage) loginPage.classList.add('hidden');
                if (mainAppContainer) mainAppContainer.classList.remove('hidden');
                if (criticalErrorDisplay) criticalErrorDisplay.classList.add('hidden');
                navigateTo('page-home');
                
                // Start listening to history for this user
                setupHistoryListeners(user.id);
                // Pre-calculate descriptor for return scan
                if (user.photo) {
                    getReferenceDescriptor(user.photo).catch(err => console.error("Failed to pre-cache descriptor:", err));
                }
            }
            
            function populateAccountPage(user) {
                if (!user) return;
                if (userPhotoEl && user.photo) {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = user.photo;
                    img.onload = () => userPhotoEl.src = img.src;
                    img.onerror = () => userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=គ្មានរូប';
                } else if (userPhotoEl) {
                    userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=User';
                }
                if (userNameEl) userNameEl.textContent = user.name || 'មិនមាន';
                if (userIdEl) userIdEl.textContent = user.id || 'មិនមាន';
                if (userGenderEl) userGenderEl.textContent = user.gender || 'មិនមាន';
                if (userGroupEl) userGroupEl.textContent = user.group || 'មិនមាន';
                if (userDepartmentEl) userDepartmentEl.textContent = user.department || 'មិនមាន';
            }

            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            
            function navigateTo(pageId) {
                console.log("Navigating to page:", pageId);
                pages.forEach(page => {
                    const pageEl = document.getElementById(page);
                    if (pageEl) pageEl.classList.add('hidden');
                });
                const targetPage = document.getElementById(pageId);
                if (targetPage) targetPage.classList.remove('hidden');
                
                if (bottomNav) {
                    if (pageId === 'page-request-leave' || pageId === 'page-request-out') {
                        bottomNav.classList.add('hidden');
                    } else {
                        bottomNav.classList.remove('hidden');
                    }
                }
                
                if (navButtons) {
                    navButtons.forEach(btn => {
                        if (btn.dataset.page === pageId) {
                            btn.classList.add('text-blue-600');
                            btn.classList.remove('text-gray-500');
                        } else {
                            btn.classList.add('text-gray-500');
                            btn.classList.remove('text-blue-600');
                        }
                    });
                }
                if (mainContent) mainContent.scrollTop = 0;

                // Reset history tabs when navigating to history
                if (pageId === 'page-history') {
                    showHistoryTab('leave');
                }
            }

            if (navButtons) {
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const pageToNavigate = button.dataset.page;
                         if (pageToNavigate) navigateTo(pageToNavigate);
                    });
                });
            }

            // --- History Page Tabs ---
            function showHistoryTab(tabName) {
                if (tabName === 'leave') {
                    if (historyTabLeave) historyTabLeave.classList.add('border-blue-600', 'text-blue-600');
                    if (historyTabLeave) historyTabLeave.classList.remove('border-transparent', 'text-gray-500');
                    if (historyTabOut) historyTabOut.classList.add('border-transparent', 'text-gray-500');
                    if (historyTabOut) historyTabOut.classList.remove('border-blue-600', 'text-blue-600');
                    
                    if (historyContainerLeave) historyContainerLeave.classList.remove('hidden');
                    if (historyContainerOut) historyContainerOut.classList.add('hidden');
                } else { // 'out' tab
                    if (historyTabLeave) historyTabLeave.classList.remove('border-blue-600', 'text-blue-600');
                    if (historyTabLeave) historyTabLeave.classList.add('border-transparent', 'text-gray-500');
                    if (historyTabOut) historyTabOut.classList.add('border-blue-600', 'text-blue-600');
                    if (historyTabOut) historyTabOut.classList.remove('border-transparent', 'text-gray-500');
                    
                    if (historyContainerLeave) historyContainerLeave.classList.add('hidden');
                    if (historyContainerOut) historyContainerOut.classList.remove('hidden');
                }
            }
            if (historyTabLeave) historyTabLeave.addEventListener('click', () => showHistoryTab('leave'));
            if (historyTabOut) historyTabOut.addEventListener('click', () => showHistoryTab('out'));

            // --- Leave Request Logic ---
            setupSearchableDropdown('leave-duration-search', 'leave-duration-dropdown', leaveDurationItems, (duration) => {
                selectedLeaveDuration = duration; // Updated by dropdown logic
                updateLeaveDateFields(duration);
            }, false); // No custom durations
            setupSearchableDropdown('leave-reason-search', 'leave-reason-dropdown', leaveReasonItems, (reason) => {
                selectedLeaveReason = reason; // Updated by dropdown logic
            }, true); // Allow custom reasons
            
            function updateLeaveDateFields(duration) {
                const today = getTodayString(); // yyyy-mm-dd
                const todayFormatted = getTodayString('dd/mm/yyyy');

                if (!leaveSingleDateContainer || !leaveDateRangeContainer || !leaveSingleDateInput || !leaveStartDateInput || !leaveEndDateInput) {
                    console.error("Date input elements not found for Leave form.");
                    return;
                }

                if (!duration) {
                    leaveSingleDateContainer.classList.add('hidden');
                    leaveDateRangeContainer.classList.add('hidden');
                    return;
                }

                if (singleDayLeaveDurations.includes(duration)) {
                    leaveSingleDateContainer.classList.remove('hidden');
                    leaveDateRangeContainer.classList.add('hidden');
                    leaveSingleDateInput.value = todayFormatted; // Show dd/mm/yyyy
                } else {
                    leaveSingleDateContainer.classList.add('hidden');
                    leaveDateRangeContainer.classList.remove('hidden');
                    leaveStartDateInput.value = today; // Input needs yyyy-mm-dd
                    const days = durationToDaysMap[duration] || 0;
                    const endDateValue = addDays(today, days);
                    leaveEndDateInput.value = endDateValue;
                    leaveEndDateInput.min = today;
                }
            }

            if (openLeaveRequestBtn) openLeaveRequestBtn.addEventListener('click', () => {
                // <<< កែប្រែ: ប្រើ showCustomAlert
                if (!currentUser) return showCustomAlert("Error", "សូម Login ជាមុនសិន។");
                
                const reqPhoto = document.getElementById('request-leave-user-photo');
                const reqName = document.getElementById('request-leave-user-name');
                const reqId = document.getElementById('request-leave-user-id');
                const reqDept = document.getElementById('request-leave-user-department');

                 if(reqPhoto) reqPhoto.src = currentUser.photo || 'https://placehold.co/60x60/e2e8f0/64748b?text=User';
                 if(reqName) reqName.textContent = currentUser.name;
                 if(reqId) reqId.textContent = currentUser.id;
                 if(reqDept) reqDept.textContent = currentUser.department || 'មិនមាន';
                
                if (leaveDurationSearchInput) leaveDurationSearchInput.value = '';
                if (leaveReasonSearchInput) leaveReasonSearchInput.value = '';
                selectedLeaveDuration = null;
                selectedLeaveReason = null;
                if (leaveSingleDateContainer) leaveSingleDateContainer.classList.add('hidden');
                if (leaveDateRangeContainer) leaveDateRangeContainer.classList.add('hidden');
                if (leaveRequestErrorEl) leaveRequestErrorEl.classList.add('hidden');
                if (leaveRequestLoadingEl) leaveRequestLoadingEl.classList.add('hidden');
                if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = false;
                
                navigateTo('page-request-leave');
            });
            if (cancelLeaveRequestBtn) cancelLeaveRequestBtn.addEventListener('click', () => navigateTo('page-home'));

            if (submitLeaveRequestBtn) submitLeaveRequestBtn.addEventListener('click', async () => {
                // Re-validate selection at submit time
                selectedLeaveDuration = leaveDurations.includes(leaveDurationSearchInput.value) ? leaveDurationSearchInput.value : null;
                selectedLeaveReason = leaveReasonSearchInput.value; // Custom allowed

                // <<< កែប្រែ: ប្រើ showCustomAlert
                if (!currentUser || !currentUser.id) return showCustomAlert("Error", "មានបញ្ហា៖ មិនអាចបញ្ជាក់អ្នកប្រើប្រាស់បានទេ។");
                
                if (!selectedLeaveDuration) {
                    if (leaveRequestErrorEl) {
                        leaveRequestErrorEl.textContent = 'សូមជ្រើសរើស "រយៈពេល" ឲ្យបានត្រឹមត្រូវ (ពីក្នុងបញ្ជី)។';
                        leaveRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                if (!selectedLeaveReason || selectedLeaveReason.trim() === '') {
                    if (leaveRequestErrorEl) {
                        leaveRequestErrorEl.textContent = 'សូមបំពេញ "មូលហេតុ" ជាមុនសិន។';
                        leaveRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                
                if (leaveRequestErrorEl) leaveRequestErrorEl.classList.add('hidden');
                if (leaveRequestLoadingEl) leaveRequestLoadingEl.classList.remove('hidden');
                if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = true;

                try {
                    const isSingleDay = singleDayLeaveDurations.includes(selectedLeaveDuration);
                    const startDateInputVal = isSingleDay 
                        ? (leaveSingleDateInput ? leaveSingleDateInput.value : getTodayString('dd/mm/yyyy')) // dd/mm/yyyy
                        : (leaveStartDateInput ? formatInputDateToDb(leaveStartDateInput.value) : getTodayString('dd/mm/yyyy')); // dd/mm/yyyy
                    
                    const endDateInputVal = isSingleDay 
                        ? startDateInputVal // dd/mm/yyyy
                        : (leaveEndDateInput ? formatInputDateToDb(leaveEndDateInput.value) : getTodayString('dd/mm/yyyy')); // dd/mm/yyyy

                    if (new Date(formatDbDateToInput(endDateInputVal)) < new Date(formatDbDateToInput(startDateInputVal))) {
                         throw new Error('"ថ្ងៃបញ្ចប់" មិនអាចនៅមុន "ថ្ងៃចាប់ផ្តើម" បានទេ។');
                    }
                    
                    const requestId = `leave_${Date.now()}`;
                    const requestData = {
                        userId: currentUser.id,
                        name: currentUser.name,
                        department: currentUser.department || 'N/A',
                        photo: currentUser.photo || null,
                        duration: selectedLeaveDuration,
                        reason: selectedLeaveReason.trim(),
                        startDate: startDateInputVal, // dd/mm/yyyy
                        endDate: endDateInputVal, // dd/mm/yyyy
                        status: 'pending', 
                        requestedAt: serverTimestamp(), 
                        requestId: requestId,
                        firestoreUserId: auth.currentUser ? auth.currentUser.uid : 'unknown_auth_user'
                    };
                    
                    if (!db || !leaveRequestsCollectionPath) throw new Error("Firestore DB or Collection Path is not initialized.");
                    const requestRef = doc(db, leaveRequestsCollectionPath, requestId);
                    await setDoc(requestRef, requestData);
                    console.log("Firestore (leave) write successful.");

                    // Send Telegram Notification
                    const dateString = (startDateInputVal === endDateInputVal) ? startDateInputVal : `ពី ${startDateInputVal} ដល់ ${endDateInputVal}`;
                    let message = `<b>🔔 សំណើសុំច្បាប់ឈប់សម្រាក 🔔</b>\n\n`;
                    message += `<b>ឈ្មោះ:</b> ${requestData.name} (${requestData.userId})\n`;
                    message += `<b>ផ្នែក:</b> ${requestData.department}\n`;
                    message += `<b>រយៈពេល:</b> ${requestData.duration}\n`;
                    message += `<b>កាលបរិច្ឆេទ:</b> ${dateString}\n`;
                    message += `<b>មូលហេតុ:</b> ${requestData.reason}\n\n`;
                    message += `(សូមចូល Firestore ដើម្បីពិនិត្យ ID: \`${requestId}\`)`;

                    await sendTelegramNotification(message);

                    if (leaveRequestLoadingEl) leaveRequestLoadingEl.classList.add('hidden');
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert('ជោគជ័យ!', 'សំណើរបស់អ្នកត្រូវបានផ្ញើដោយជោគជ័យ!', 'success');
                    navigateTo('page-history');

                } catch (error) {
                    console.error("Error submitting leave request:", error);
                     let displayError = error.message;
                     if (error.code && error.code.includes('permission-denied')) {
                         displayError = 'Missing or insufficient permissions. សូមពិនិត្យ Firestore Rules។';
                     }
                    if (leaveRequestErrorEl) {
                        leaveRequestErrorEl.textContent = `Error: ${displayError}`;
                        leaveRequestErrorEl.classList.remove('hidden');
                    }
                    if (leaveRequestLoadingEl) leaveRequestLoadingEl.classList.add('hidden');
                    if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = false;
                }
            });
            
            // --- Out Request Logic ---
            setupSearchableDropdown('out-duration-search', 'out-duration-dropdown', outDurationItems, (duration) => {
                selectedOutDuration = duration;
            }, false); // No custom durations
            setupSearchableDropdown('out-reason-search', 'out-reason-dropdown', outReasonItems, (reason) => {
                selectedOutReason = reason;
            }, true); // Allow custom reasons

            if (openOutRequestBtn) openOutRequestBtn.addEventListener('click', () => {
                // <<< កែប្រែ: ប្រើ showCustomAlert
                if (!currentUser) return showCustomAlert("Error", "សូម Login ជាមុនសិន។");
                
                const reqPhoto = document.getElementById('request-out-user-photo');
                const reqName = document.getElementById('request-out-user-name');
                const reqId = document.getElementById('request-out-user-id');
                const reqDept = document.getElementById('request-out-user-department');

                 if(reqPhoto) reqPhoto.src = currentUser.photo || 'https://placehold.co/60x60/e2e8f0/64748b?text=User';
                 if(reqName) reqName.textContent = currentUser.name;
                 if(reqId) reqId.textContent = currentUser.id;
                 if(reqDept) reqDept.textContent = currentUser.department || 'មិនមាន';
                
                if (outDurationSearchInput) outDurationSearchInput.value = '';
                if (outReasonSearchInput) outReasonSearchInput.value = '';
                if (outDateInput) outDateInput.value = getTodayString('dd/mm/yyyy'); // Set today dd/mm/yyyy
                selectedOutDuration = null;
                selectedOutReason = null;
                if (outRequestErrorEl) outRequestErrorEl.classList.add('hidden');
                if (outRequestLoadingEl) outRequestLoadingEl.classList.add('hidden');
                if (submitOutRequestBtn) submitOutRequestBtn.disabled = false;
                
                navigateTo('page-request-out');
            });
            if (cancelOutRequestBtn) cancelOutRequestBtn.addEventListener('click', () => navigateTo('page-home'));

            if (submitOutRequestBtn) submitOutRequestBtn.addEventListener('click', async () => {
                // Re-validate selection at submit time
                selectedOutDuration = outDurations.includes(outDurationSearchInput.value) ? outDurationSearchInput.value : null;
                selectedOutReason = outReasonSearchInput.value;

                // <<< កែប្រែ: ប្រើ showCustomAlert
                if (!currentUser || !currentUser.id) return showCustomAlert("Error", "មានបញ្ហា៖ មិនអាចបញ្ជាក់អ្នកប្រើប្រាស់បានទេ។");
                
                if (!selectedOutDuration) {
                    if (outRequestErrorEl) {
                        outRequestErrorEl.textContent = 'សូមជ្រើសរើស "រយៈពេល" ឲ្យបានត្រឹមត្រូវ (ពីក្នុងបញ្ជី)។';
                        outRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                if (!selectedOutReason || selectedOutReason.trim() === '') {
                    if (outRequestErrorEl) {
                        outRequestErrorEl.textContent = 'សូមបំពេញ "មូលហេតុ" ជាមុនសិន។';
                        outRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                
                if (outRequestErrorEl) outRequestErrorEl.classList.add('hidden');
                if (outRequestLoadingEl) outRequestLoadingEl.classList.remove('hidden');
                if (submitOutRequestBtn) submitOutRequestBtn.disabled = true;

                try {
                    const dateVal = outDateInput ? outDateInput.value : getTodayString('dd/mm/yyyy');
                    const requestId = `out_${Date.now()}`;
                    
                    const requestData = {
                        userId: currentUser.id,
                        name: currentUser.name,
                        department: currentUser.department || 'N/A',
                        photo: currentUser.photo || null,
                        duration: selectedOutDuration,
                        reason: selectedOutReason.trim(),
                        startDate: dateVal, // dd/mm/yyyy
                        endDate: dateVal, // dd/mm/yyyy
                        status: 'pending', 
                        requestedAt: serverTimestamp(), 
                        requestId: requestId,
                        firestoreUserId: auth.currentUser ? auth.currentUser.uid : 'unknown_auth_user'
                    };
                    
                    if (!db || !outRequestsCollectionPath) throw new Error("Firestore DB or Out Collection Path is not initialized.");
                    const requestRef = doc(db, outRequestsCollectionPath, requestId);
                    await setDoc(requestRef, requestData);
                    console.log("Firestore (out) write successful.");

                    // Send Telegram Notification
                    let message = `<b>🔔 សំណើសុំច្បាប់ចេញក្រៅ 🔔</b>\n\n`;
                    message += `<b>ឈ្មោះ:</b> ${requestData.name} (${requestData.userId})\n`;
                    message += `<b>ផ្នែក:</b> ${requestData.department}\n`;
                    message += `<b>រយៈពេល:</b> ${requestData.duration}\n`;
                    message += `<b>កាលបរិច្ឆេទ:</b> ${requestData.startDate}\n`;
                    message += `<b>មូលហេតុ:</b> ${requestData.reason}\n\n`;
                    message += `(សូមចូល Firestore ដើម្បីពិនិត្យ ID: \`${requestId}\`)`;

                    await sendTelegramNotification(message);

                    if (outRequestLoadingEl) outRequestLoadingEl.classList.add('hidden');
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert('ជោគជ័យ!', 'សំណើរបស់អ្នកត្រូវបានផ្ញើដោយជោគជ័យ!', 'success');
                    navigateTo('page-history');

                } catch (error) {
                    console.error("Error submitting out request:", error);
                     let displayError = error.message;
                     if (error.code && error.code.includes('permission-denied')) {
                         displayError = 'Missing or insufficient permissions. សូមពិនិត្យ Firestore Rules។';
                     }
                    if (outRequestErrorEl) {
                        outRequestErrorEl.textContent = `Error: ${displayError}`;
                        outRequestErrorEl.classList.remove('hidden');
                    }
                    if (outRequestLoadingEl) outRequestLoadingEl.classList.add('hidden');
                    if (submitOutRequestBtn) submitOutRequestBtn.disabled = false;
                }
            });


            // --- Telegram Helper ---
            async function sendTelegramNotification(message) {
                 console.log("Sending Telegram notification...");
                 try {
                     const telegramUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                     const telegramResponse = await fetch(telegramUrl, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             chat_id: CHAT_ID,
                             text: message,
                             parse_mode: 'HTML'
                         })
                     });
                      if (!telegramResponse.ok) {
                          const errorBody = await telegramResponse.text();
                          console.error("Telegram API error:", telegramResponse.status, errorBody);
                     } else {
                         console.log("Telegram notification sent successfully.");
                     }
                 } catch (e) {
                      console.error("Failed to send Telegram message:", e);
                 }
            }
            
            // --- (((( ថ្មី: Custom Alert Modal Logic )))) ---
            function showCustomAlert(title, message, type = 'warning') {
                if (!customAlertModal) return; // Failsafe

                if (customAlertTitle) customAlertTitle.textContent = title;
                if (customAlertMessage) customAlertMessage.textContent = message;

                if (type === 'success') {
                    if (customAlertIconSuccess) customAlertIconSuccess.classList.remove('hidden');
                    if (customAlertIconWarning) customAlertIconWarning.classList.add('hidden');
                } else { // default to warning
                    if (customAlertIconSuccess) customAlertIconSuccess.classList.add('hidden');
                    if (customAlertIconWarning) customAlertIconWarning.classList.remove('hidden');
                }

                customAlertModal.classList.remove('hidden');
            }

            function hideCustomAlert() {
                if (customAlertModal) customAlertModal.classList.add('hidden');
            }
            // --- (((( End of Custom Alert Modal Logic )))) ---


            // --- History Page Logic (Real-time) ---
            function setupHistoryListeners(currentEmployeeId) {
                console.log("Setting up history listeners for employee ID:", currentEmployeeId);
                
                // --- Stop old listeners ---
                if (historyUnsubscribe) historyUnsubscribe();
                if (outHistoryUnsubscribe) outHistoryUnsubscribe();

                if (!db) return console.error("Firestore DB not initialized.");
                if (!currentEmployeeId) return console.error("Current Employee ID not set.");
                
                // --- Get date range for current month ---
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1); // First day of next month

                const startTimestamp = Timestamp.fromDate(startOfMonth);
                const endTimestamp = Timestamp.fromDate(endOfMonth);

                // --- Listener 1: Leave Requests ---
                try {
                    const leaveQuery = query(
                        collection(db, leaveRequestsCollectionPath),
                        where("userId", "==", currentEmployeeId),
                        where("requestedAt", ">=", startTimestamp),
                        where("requestedAt", "<", endTimestamp)
                    );
                    console.log("Querying Leave Requests for current month...");
                    historyUnsubscribe = onSnapshot(leaveQuery, (snapshot) => {
                        console.log(`Received LEAVE snapshot. Size: ${snapshot.size}`);
                        renderHistoryList(snapshot, historyContainerLeave, historyPlaceholderLeave, 'leave');
                    }, (error) => {
                        console.error("Error listening to LEAVE history:", error);
                        if (historyPlaceholderLeave) {
                            historyPlaceholderLeave.innerHTML = `<p class="text-red-500">Error: មិនអាចទាញយកប្រវត្តិបានទេ ${error.code.includes('permission-denied') ? '(Permission Denied)' : (error.code.includes('requires an index') ? '(ត្រូវបង្កើត Index សូមមើល Console)' : '')}</p>`;
                            historyPlaceholderLeave.classList.remove('hidden');
                        }
                    });
                } catch (e) {
                     console.error("Failed to create LEAVE history query:", e);
                     if (historyPlaceholderLeave) historyPlaceholderLeave.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
                     historyPlaceholderLeave.classList.remove('hidden');
                 }

                // --- Listener 2: Out Requests ---
                try {
                    const outQuery = query(
                        collection(db, outRequestsCollectionPath),
                        where("userId", "==", currentEmployeeId),
                        where("requestedAt", ">=", startTimestamp),
                        where("requestedAt", "<", endTimestamp)
                    );
                    console.log("Querying Out Requests for current month...");
                    outHistoryUnsubscribe = onSnapshot(outQuery, (snapshot) => {
                        console.log(`Received OUT snapshot. Size: ${snapshot.size}`);
                        renderHistoryList(snapshot, historyContainerOut, historyPlaceholderOut, 'out');
                    }, (error) => {
                        console.error("Error listening to OUT history:", error);
                        if (historyPlaceholderOut) {
                            historyPlaceholderOut.innerHTML = `<p class="text-red-500">Error: មិនអាចទាញយកប្រវត្តិបានទេ ${error.code.includes('permission-denied') ? '(Permission Denied)' : (error.code.includes('requires an index') ? '(ត្រូវបង្កើត Index សូមមើល Console)' : '')}</p>`;
                            historyPlaceholderOut.classList.remove('hidden');
                        }
                    });
                } catch (e) {
                     console.error("Failed to create OUT history query:", e);
                     if (historyPlaceholderOut) historyPlaceholderOut.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
                     historyPlaceholderOut.classList.remove('hidden');
                 }
            }
            
            function getSortPriority(status) {
                switch(status) {
                    case 'pending': return 1;
                    case 'editing': return 2;
                    case 'approved': return 3;
                    case 'rejected': return 4;
                    default: return 5;
                }
            }

            function renderHistoryList(snapshot, container, placeholder, type) {
                if (!container || !placeholder) return;
                
                if (snapshot.empty) {
                    placeholder.classList.remove('hidden');
                    container.innerHTML = ''; 
                } else {
                    placeholder.classList.add('hidden');
                    container.innerHTML = ''; 
                    
                    const requests = [];
                    snapshot.forEach(doc => requests.push(doc.data()));

                    // Sort: 1. By status (pending/editing first), 2. By date (newest first)
                    requests.sort((a, b) => {
                        const priorityA = getSortPriority(a.status);
                        const priorityB = getSortPriority(b.status);
                        
                        if (priorityA !== priorityB) {
                            return priorityA - priorityB; // Lower priority number comes first
                        }
                        
                        // If priority is same, sort by date (newest first)
                        const timeA = a.requestedAt?.toMillis ? a.requestedAt.toMillis() : 0;
                        const timeB = b.requestedAt?.toMillis ? b.requestedAt.toMillis() : 0;
                        return timeB - timeA; 
                    });
                    
                    requests.forEach(request => container.innerHTML += renderHistoryCard(request, type));
                }
            }

            // Function renderHistoryCard (with CSS class fixes)
            function renderHistoryCard(request, type) {
                 if (!request || !request.requestId) return '';
                
                let statusColor, statusText, decisionTime = '';
                switch(request.status) {
                    case 'approved':
                        statusColor = 'bg-green-100 text-green-800';
                        statusText = 'បានយល់ព្រម';
                        if (request.decisionAt) {
                            decisionTime = `<p class="text-xs text-green-600 mt-1">នៅម៉ោង: ${request.decisionAt}</p>`;
                        }
                        break;
                    case 'rejected':
                        statusColor = 'bg-red-100 text-red-800';
                        statusText = 'បានបដិសេធ';
                         if (request.decisionAt) {
                            decisionTime = `<p class="text-xs text-red-600 mt-1">នៅម៉ោង: ${request.decisionAt}</p>`;
                         }
                        break;
                    case 'editing':
                        statusColor = 'bg-blue-100 text-blue-800';
                        statusText = 'កំពុងកែសម្រួល';
                        break;
                    default: // pending
                        statusColor = 'bg-yellow-100 text-yellow-800';
                        statusText = 'កំពុងរង់ចាំ';
                }

                const dateString = (request.startDate === request.endDate) 
                    ? request.startDate 
                     : (request.startDate && request.endDate ? `${request.startDate} ដល់ ${request.endDate}` : 'N/A');

                // Show Edit/Delete buttons only if request is pending or editing
                const showActions = (request.status === 'pending' || request.status === 'editing');

                // Logic for Return Button
                let returnInfo = '';
                let returnButton = '';
                if (type === 'out') {
                    if (request.returnStatus === 'បានចូលមកវិញ') {
                        returnInfo = `<p class="text-sm font-semibold text-green-700 mt-2">✔️ បានចូលមកវិញ: ${request.returnedAt || ''}</p>`;
                    } else if (request.status === 'approved') {
                        // Show button only if approved and not yet returned
                        returnButton = `
                            <button data-id="${request.requestId}" class="return-btn w-full mt-3 py-2 px-3 bg-green-600 text-white rounded-lg font-semibold text-sm shadow-sm hover:bg-green-700">
                                បញ្ជាក់ចូលមកវិញ
                            </button>
                        `;
                    }
                }

                return `
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 mb-4">
                        <div class="flex justify-between items-start">
                            <span class="font-semibold text-gray-800">${request.duration || 'N/A'}</span>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${dateString}</p>
                        <p class="text-sm text-gray-500 mt-1"><b>មូលហេតុ:</b> ${request.reason || 'មិនបានបញ្ជាក់'}</p>
                        ${decisionTime}
                        ${returnInfo} <div class="mt-3 pt-3 border-t border-gray-100">
                             <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-400">ID: ${request.requestId}</p>
                                ${showActions ? `
                                    <div class="flex space-x-2">
                                        <button data-id="${request.requestId}" data-type="${type}" class="edit-btn p-1 text-blue-600 hover:text-blue-800">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                        </button>
                                        <button data-id="${request.requestId}" data-type="${type}" class="delete-btn p-1 text-red-600 hover:text-red-800">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                ` : ''}
                             </div>
                             ${returnButton} </div>
                    </div>
                `;
            }

            // --- Edit/Delete/Return Event Delegation ---
            document.body.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const returnBtn = e.target.closest('.return-btn');

                if (editBtn) {
                    console.log("Edit button clicked for:", editBtn.dataset.id, "Type:", editBtn.dataset.type);
                    await openEditModal(editBtn.dataset.id, editBtn.dataset.type);
                }
                
                if (deleteBtn) {
                    console.log("Delete button clicked for:", deleteBtn.dataset.id, "Type:", deleteBtn.dataset.type);
                    openDeleteModal(deleteBtn.dataset.id, deleteBtn.dataset.type);
                }

                if (returnBtn) {
                    console.log("Return button clicked for:", returnBtn.dataset.id);
                    await startReturnConfirmation(returnBtn.dataset.id);
                }
            });

            async function openEditModal(requestId, type) {
                if (!db || !requestId || !type) return;
                
                const collectionPath = (type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                if (!collectionPath) return;

                if (editLoadingEl) editLoadingEl.classList.remove('hidden');
                if (editErrorEl) editErrorEl.classList.add('hidden');
                if (editModal) editModal.classList.remove('hidden');

                try {
                    const requestRef = doc(db, collectionPath, requestId);
                    
                    // Set status to 'editing'
                    await updateDoc(requestRef, { status: 'editing' });
                    console.log("Request status set to 'editing'");
                    
                    // Get the document data
                    const docSnap = await getDoc(requestRef); // Need getDoc
                    if (!docSnap.exists()) throw new Error("Document not found");
                    const data = docSnap.data();

                    if (editModalTitle) editModalTitle.textContent = (type === 'leave') ? "កែសម្រួលច្បាប់ឈប់" : "កែសម្រួលច្បាប់ចេញក្រៅ";
                    if (editRequestId) editRequestId.value = requestId; // Store ID
                    
                    // Populate existing values
                    if (editReasonSearch) editReasonSearch.value = data.reason || '';
                    if (editDurationSearch) editDurationSearch.value = data.duration;
                    
                    // Re-setup dropdowns for the modal
                    setupSearchableDropdown('edit-duration-search', 'edit-duration-dropdown', (type === 'leave' ? leaveDurationItems : outDurationItems), (duration) => {}, false);
                    setupSearchableDropdown('edit-reason-search', 'edit-reason-dropdown', (type === 'leave' ? leaveReasonItems : outReasonItems), (reason) => {}, true);
                    
                    // Handle date fields
                    if (type === 'leave') {
                        if (singleDayLeaveDurations.includes(data.duration)) {
                            if (editSingleDateContainer) editSingleDateContainer.classList.remove('hidden');
                            if (editDateRangeContainer) editDateRangeContainer.classList.add('hidden');
                            if (editLeaveDateSingle) editLeaveDateSingle.value = data.startDate; // dd/mm/yyyy
                        } else {
                            if (editSingleDateContainer) editSingleDateContainer.classList.add('hidden');
                            if (editDateRangeContainer) editDateRangeContainer.classList.remove('hidden');
                            if (editLeaveDateStart) editLeaveDateStart.value = formatDbDateToInput(data.startDate); // yyyy-mm-dd
                            if (editLeaveDateEnd) editLeaveDateEnd.value = formatDbDateToInput(data.endDate); // yyyy-mm-dd
                        }
                    } else { // 'out'
                         if (editSingleDateContainer) editSingleDateContainer.classList.remove('hidden');
                         if (editDateRangeContainer) editDateRangeContainer.classList.add('hidden');
                         if (editLeaveDateSingle) editLeaveDateSingle.value = data.startDate; // dd/mm/yyyy
                    }
                    
                    if (editLoadingEl) editLoadingEl.classList.add('hidden');
                    
                } catch (e) {
                    console.error("Error opening edit modal:", e);
                    if (editLoadingEl) editLoadingEl.classList.add('hidden');
                    if (editErrorEl) {
                        editErrorEl.textContent = `Error: ${e.message}`;
                        editErrorEl.classList.remove('hidden');
                    }
                }
            }
            
            // --- Cancel Edit Button ---
            if (cancelEditBtn) cancelEditBtn.addEventListener('click', async () => {
                const requestId = editRequestId.value;
                const type = (editModalTitle.textContent.includes("ឈប់")) ? 'leave' : 'out';
                const collectionPath = (type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                
                if (requestId && collectionPath) {
                    // Revert status from 'editing' back to 'pending'
                    try {
                        const requestRef = doc(db, collectionPath, requestId);
                        await updateDoc(requestRef, { status: 'pending' });
                        console.log("Edit cancelled, status reverted to 'pending'");
                    } catch (e) {
                        console.error("Error reverting status on edit cancel:", e);
                    }
                }
                if (editModal) editModal.classList.add('hidden');
            });
            
            // --- Submit Edit Button ---
            if (submitEditBtn) submitEditBtn.addEventListener('click', async () => {
                const requestId = editRequestId.value;
                const type = (editModalTitle.textContent.includes("ឈប់")) ? 'leave' : 'out';
                const collectionPath = (type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                
                // --- This simple version only updates reason ---
                const newReason = editReasonSearch.value;
                
                if (!requestId || !collectionPath || !newReason || newReason.trim() === '') {
                    if(editErrorEl) {
                        editErrorEl.textContent = "មូលហេតុមិនអាចទទេបានទេ។";
                        editErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                
                if (editLoadingEl) editLoadingEl.classList.remove('hidden');
                if (editErrorEl) editErrorEl.classList.add('hidden');
                
                try {
                    const requestRef = doc(db, collectionPath, requestId);
                    
                    // Update Firestore
                    await updateDoc(requestRef, {
                        reason: newReason.trim(),
                        status: 'pending', // Set status back to 'pending'
                        requestedAt: serverTimestamp() // Update timestamp
                    });
                    
                    console.log("Edit submitted, status set to 'pending'");
                    
                    let message = `<b>🔔 សំណើត្រូវបានកែសម្រួល 🔔</b>\n\n`;
                    message += `<b>ID:</b> \`${requestId}\`\n`;
                    message += `<b>មូលហេតុថ្មី:</b> ${newReason.trim()}\n\n`;
                    message += `(សំណើនេះ ឥឡូវនេះ ស្ថិតក្នុងស្ថានភាព \'pending\' ឡើងវិញ)`;
                    
                    await sendTelegramNotification(message);
                    
                    if (editLoadingEl) editLoadingEl.classList.add('hidden');
                    if (editModal) editModal.classList.add('hidden');
                    
                } catch (e) {
                    console.error("Error submitting edit:", e);
                    if (editLoadingEl) editLoadingEl.classList.add('hidden');
                    if (editErrorEl) {
                        editErrorEl.textContent = `Error: ${e.message}`;
                        editErrorEl.classList.remove('hidden');
                    }
                }
            });

            // --- Delete Modal Logic ---
            function openDeleteModal(requestId, type) {
                if (deleteRequestId) deleteRequestId.value = requestId;
                if (deleteCollectionType) deleteCollectionType.value = type;
                if (deleteModal) deleteModal.classList.remove('hidden');
            }
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => {
                if (deleteModal) deleteModal.classList.add('hidden');
            });
            
            if (deleteConfirmBtn) deleteConfirmBtn.addEventListener('click', async () => {
                const requestId = deleteRequestId.value;
                const type = deleteCollectionType.value;
                const collectionPath = (type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                
                if (!db || !requestId || !collectionPath) {
                    console.error("Cannot delete: Missing info");
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    return showCustomAlert("Error", "មិនអាចលុបបានទេ។");
                }
                
                console.log("Attempting to delete doc:", requestId, "from:", collectionPath);
                
                // Show loading state
                deleteConfirmBtn.disabled = true;
                deleteConfirmBtn.textContent = 'កំពុងលុប...';
                
                try {
                    // Use deleteDoc
                    const requestRef = doc(db, collectionPath, requestId);
                    await deleteDoc(requestRef); 
                    
                    console.log("Document successfully deleted!");
                    if (deleteModal) deleteModal.classList.add('hidden');
                    
                } catch (e) {
                    console.error("Error deleting document:", e);
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("Error", `មិនអាចលុបបានទេ។ ${e.message}`);
                } finally {
                    // Reset button
                    deleteConfirmBtn.disabled = false;
                    deleteConfirmBtn.textContent = 'យល់ព្រមលុប';
                }
            });


            // --- (((( RETURN CONFIRMATION LOGIC )))) ---

            // Point in Polygon Helper
            function isPointInPolygon(point, polygon) {
                const [lat, lng] = point;
                let isInside = false;
                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                    const [lat_i, lng_i] = polygon[i];
                    const [lat_j, lng_j] = polygon[j];

                    const intersect = ((lng_i > lng) !== (lng_j > lng))
                        && (lat < (lat_j - lat_i) * (lng - lng_i) / (lng_j - lng_i) + lat_i);
                    if (intersect) isInside = !isInside;
                }
                return isInside;
            }

            async function startReturnConfirmation(requestId) {
                console.log("startReturnConfirmation called for:", requestId);
                if (!currentUser || !currentUser.photo) {
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("Error", "មិនអាចទាញយករូបថតយោងរបស់អ្នកបានទេ។");
                    return;
                }
                
                currentReturnRequestId = requestId; // Store the ID
                if (returnScanModal) returnScanModal.classList.remove('hidden');
                if (returnScanStatusEl) returnScanStatusEl.textContent = 'កំពុងព្យាយាមបើកកាមេរ៉ា...';
                if (returnScanDebugEl) returnScanDebugEl.textContent = '';

                try {
                    // 1. Compute reference descriptor (using cache if available)
                    if (returnScanStatusEl) returnScanStatusEl.textContent = 'កំពុងវិភាគរូបថតយោង...';
                    const referenceDescriptor = await getReferenceDescriptor(currentUser.photo);

                    // 2. Start video stream
                    if (returnScanStatusEl) returnScanStatusEl.textContent = 'កំពុងស្នើសុំបើកកាមេរ៉ា...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    if (returnVideo) returnVideo.srcObject = stream;
                    if (returnScanStatusEl) returnScanStatusEl.textContent = 'សូមដាក់មុខរបស់អ្នកឲ្យចំកាមេរ៉ា';

                    // 3. Start detection interval
                    if (faceScanInterval) clearInterval(faceScanInterval); 
                    faceScanInterval = setInterval(async () => {
                        if (!returnVideo || returnVideo.readyState < 3) return; 

                        const detections = await faceapi.detectSingleFace(returnVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true).withFaceDescriptor();
                        
                        if (detections) {
                            if (returnScanStatusEl) returnScanStatusEl.textContent = 'រកឃើញផ្ទៃមុខ! កំពុងផ្ទៀងផ្ទាត់...';
                            const distance = faceapi.euclideanDistance(referenceDescriptor, detections.descriptor);
                            const similarity = (1 - distance).toFixed(2);
                            const threshold = 0.55; 
                            if (returnScanDebugEl) returnScanDebugEl.textContent = `ភាពស្រដៀងគ្នា: ${similarity} (ត្រូវតែ > ${1-threshold})`;

                            if (distance < threshold) { 
                                // Face Scan Success!
                                if (returnScanStatusEl) returnScanStatusEl.textContent = 'ផ្ទៀងផ្ទាត់មុខ ជោគជ័យ!';
                                stopReturnScan(false); // Stop scan but don't clear ID
                                handleReturnFaceScanSuccess();
                            } else {
                                if (returnScanStatusEl) returnScanStatusEl.textContent = 'មុខមិនត្រឹមត្រូវ... សូមព្យាយាមម្តងទៀត';
                            }
                        } else {
                            if (returnScanStatusEl) returnScanStatusEl.textContent = 'រកមិនឃើញផ្ទៃមុខ...';
                            if (returnScanDebugEl) returnScanDebugEl.textContent = '';
                        }
                    }, 500);

                } catch (error) {
                    console.error("Error during return scan process:", error);
                    if (returnScanStatusEl) returnScanStatusEl.textContent = `Error: ${error.message}`;
                    stopReturnScan(true); // Stop scan and clear ID
                    setTimeout(() => { 
                        if (returnScanModal) returnScanModal.classList.add('hidden'); 
                        // <<< កែប្រែ: ប្រើ showCustomAlert
                        showCustomAlert("បញ្ហាស្កេនមុខ", `មានបញ្ហា៖\n${error.message}\nសូមប្រាកដថាអ្នកបានអនុញ្ញាតឲ្យប្រើកាមេរ៉ា។`);
                    }, 1500); 
                }
            }
            
            function stopReturnScan(clearId = true) {
                if (faceScanInterval) clearInterval(faceScanInterval);
                faceScanInterval = null;
                if (returnVideo && returnVideo.srcObject) {
                    returnVideo.srcObject.getTracks().forEach(track => track.stop());
                    returnVideo.srcObject = null;
                }
                if (clearId) {
                    currentReturnRequestId = null;
                }
            }

            if (cancelReturnScanBtn) cancelReturnScanBtn.addEventListener('click', () => {
                stopReturnScan(true);
                if (returnScanModal) returnScanModal.classList.add('hidden');
            });

            function handleReturnFaceScanSuccess() {
                if (returnScanStatusEl) returnScanStatusEl.textContent = 'ស្កេនមុខជោគជ័យ!\nកំពុងស្នើសុំទីតាំង...';
                if (returnScanDebugEl) returnScanDebugEl.textContent = 'សូមអនុញ្ញាតឲ្យប្រើ Location';

                // Request High Accuracy Location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        onLocationSuccess, 
                        onLocationError, 
                        {
                            enableHighAccuracy: true,
                            timeout: 10000, // 10 seconds timeout
                            maximumAge: 0 // Force fresh location
                        }
                    );
                } else {
                    console.error("Geolocation is not supported by this browser.");
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("បញ្ហាទីតាំង", LOCATION_FAILURE_MESSAGE);
                    if (returnScanModal) returnScanModal.classList.add('hidden');
                    currentReturnRequestId = null;
                }
            }

            async function onLocationSuccess(position) {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                console.log(`Location found: ${userLat}, ${userLng}`);
                if (returnScanStatusEl) returnScanStatusEl.textContent = 'បានទីតាំង! កំពុងពិនិត្យ...';
                if (returnScanDebugEl) returnScanDebugEl.textContent = `Lat: ${userLat.toFixed(6)}, Lng: ${userLng.toFixed(6)}`;

                // Check if point is inside the polygon
                const isInside = isPointInPolygon([userLat, userLng], allowedAreaCoords);

                if (isInside) {
                    console.log("User is INSIDE the allowed area.");
                    if (returnScanStatusEl) returnScanStatusEl.textContent = 'ទីតាំងត្រឹមត្រូវ! កំពុងរក្សាទុក...';
                    await updateReturnStatusInFirestore();
                } else {
                    console.log("User is OUTSIDE the allowed area.");
                    if (returnScanStatusEl) returnScanStatusEl.textContent = 'ទីតាំងមិនត្រឹមត្រូវ។';
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("បញ្ហាទីតាំង", LOCATION_FAILURE_MESSAGE);
                    if (returnScanModal) returnScanModal.classList.add('hidden');
                    currentReturnRequestId = null;
                }
            }

            function onLocationError(error) {
                console.error(`Geolocation Error (${error.code}): ${error.message}`);
                if (returnScanStatusEl) returnScanStatusEl.textContent = 'មិនអាចទាញយកទីតាំងបានទេ។';
                // <<< កែប្រែ: ប្រើ showCustomAlert
                showCustomAlert("បញ្ហាទីតាំង", LOCATION_FAILURE_MESSAGE);
                if (returnScanModal) returnScanModal.classList.add('hidden');
                currentReturnRequestId = null;
            }

            async function updateReturnStatusInFirestore() {
                if (!currentReturnRequestId) {
                    console.error("Cannot update return status: No request ID");
                    return;
                }

                try {
                    const docRef = doc(db, outRequestsCollectionPath, currentReturnRequestId);
                    
                    // Generate timestamp string
                    const now = new Date();
                    const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); // HH:mm
                    const date = now.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }); // dd/mm/yyyy
                    const returnedAtString = `${time} ${date}`;

                    await updateDoc(docRef, {
                        returnStatus: "បានចូលមកវិញ",
                        returnedAt: returnedAtString
                    });

                    console.log("Return status updated successfully.");
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("ជោគជ័យ!", "បញ្ជាក់ការចូលមកវិញ បានជោគជ័យ!", "success");

                } catch (e) {
                    console.error("Error updating Firestore return status:", e);
                    // <<< កែប្រែ: ប្រើ showCustomAlert
                    showCustomAlert("Error", `មានបញ្ហាពេលរក្សាទុក: ${e.message}`);
                } finally {
                    if (returnScanModal) returnScanModal.classList.add('hidden');
                    currentReturnRequestId = null;
                }
            }

            // --- (((( END OF RETURN CONFIRMATION LOGIC )))) ---


        }); // End of DOMContentLoaded
    </script>
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        /* Custom scrollbar for dropdown */
        .dropdown-list {
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        .dropdown-list::-webkit-scrollbar { width: 6px; }
        .dropdown-list::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 10px; }
        .dropdown-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #f3f4f6; }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure request pages fill screen */
        #page-request-leave, #page-request-out {
            min-height: 100vh;
        }
        
        /* History Tab highlighting */
        .history-tab.active {
            border-bottom-width: 3px;
            border-color: #2563eb; /* blue-600 */
            color: #2563eb;
        }
        .history-tab {
            border-bottom-width: 3px;
            border-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ===== CRITICAL ERROR DISPLAY ===== -->
    <div id="critical-error-display" class="max-w-md mx-auto min-h-screen flex flex-col justify-center items-center p-6 text-center text-red-600 font-semibold hidden">
        <!-- Error message will be injected here by JS -->
    </div>

    <!-- ===== LOGIN PAGE ===== -->
    <div id="page-login" class="max-w-md mx-auto min-h-screen flex flex-col justify-center items-center p-6 bg-gray-50">
        <!-- Logo and Title -->
        <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-20 w-20 mb-4">
        <h1 class="text-2xl font-bold text-blue-800 mb-2">ឧស្សាហកម្មឌីជីថល</h1>
        <p class="text-gray-600 mb-8">សូមចូលប្រើកម្មវិធីសុំច្បាប់</p>

        <!-- In-App Browser Warning -->
        <div id="in-app-warning" class="w-full max-w-sm p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 text-sm text-left hidden">
            <p class="font-bold text-base mb-2">បញ្ហាកាមេរ៉ា!</p>
            <p>កម្មវិធីនេះ ត្រូវការបើកកាមេរ៉ា ដែលមិនអាចដំណើរការក្នុង Telegram/Facebook បានទេ។</p>
            <p class="font-semibold mt-3">ដំណោះស្រាយ៖</p>
            <ol class="list-decimal list-inside mt-1">
                <li>នៅខាងលើស្តាំ, ចុចសញ្ញា <span class="font-bold">...</span></li>
                <li>ជ្រើសរើស "Open in Browser" (បើកក្នុង Browser)</li>
            </ol>
            <p class="mt-2">បន្ទាប់មក កម្មវិធីនឹងបើកក្នុង Chrome/Safari ហើយកាមេរ៉ានឹងដំណើរការ។</p>
        </div>

        <!-- Data Loading Indicator -->
        <div id="data-loading-indicator" class="w-full max-w-sm p-6 bg-white rounded-lg shadow-md border border-gray-200 flex flex-col items-center justify-center hidden">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600 font-medium">កំពុងទាញយកទិន្នន័យបុគ្គលិក...</p>
            <p class="text-xs text-gray-400 mt-1">សូមរង់ចាំបន្តិច</p>
        </div>

        <!-- Form (will be hidden until data loads) -->
        <div id="login-form-container" class="w-full bg-white p-6 rounded-lg shadow-md border border-gray-200 hidden">
            <label for="user-search" class="block text-sm font-medium text-gray-700 mb-2">ជ្រើសរើសអត្តលេខ (ID)</label>
            <div class="relative">
                <input
                    type="text"
                    id="user-search"
                    placeholder="វាយ ឬ ជ្រើសរើស..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    autocomplete="off"
                >
                <div
                    id="user-dropdown"
                    class="dropdown-list absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                ></div>
            </div>
            <p id="user-search-error" class="text-red-500 text-sm mt-1 hidden">សូមជ្រើសរើសអត្តលេខឲ្យបានត្រឹមត្រូវ</p>
            
            <div class="flex items-center mt-4">
                <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="remember-me" class="ml-2 block text-sm text-gray-700">ចងចាំខ្ញុំនៅលើ Device នេះ</label>
            </div>

            <button id="scan-face-btn" class="mt-6 w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 flex items-center justify-center space-x-2 disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm11 11H5V5h10v8zm-5 2a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                <span>ចូលដោយស្កេនផ្ទៃមុខ</span>
            </button>
            <p id="model-status" class="text-xs text-gray-500 text-center mt-2"></p>
        </div>
    </div>

    <!-- ===== Face Scan Modal ===== -->
    <div id="face-scan-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md text-center">
            <h3 class="text-xl font-bold mb-4">កំពុងស្កេនផ្ទៃមុខ</h3>
            <div class="relative w-full h-64 bg-gray-800 rounded-lg overflow-hidden border-4 border-blue-500">
                <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
            </div>
            <p id="scan-status" class="mt-4 text-lg font-medium text-gray-700">រកមិនឃើញផ្ទៃមុខ...</p>
            <p id="scan-debug" class="text-xs text-gray-500 h-4"></p>
            <button id="cancel-scan-btn" class="mt-4 w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                បោះបង់
            </button>
        </div>
    </div>

    <!-- ===== MAIN APP (Hidden by default) ===== -->
    <div id="main-app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-lg hidden">
        
        <!-- Main Content Area (scrollable) -->
        <main id="main-content" class="pb-20" style="height: 100vh; overflow-y: auto;">
            
            <!-- ===== PAGE 1: HOME (ទំព័រដើម) ===== -->
            <div id="page-home" class="p-6">
                <!-- Header -->
                <header class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-10 w-10 rounded-full border">
                        <div>
                            <p class="text-sm text-gray-500">ស្វាគមន៍</p>
                            <h2 id="home-user-name" class="text-xl font-bold text-gray-800">...</h2>
                        </div>
                    </div>
                </header>

                <!-- Request Types Section -->
                <section>
                    <h3 class="text-md font-semibold text-gray-700 mb-3">ប្រភេទសំណើសុំច្បាប់</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Leave Request -->
                        <button id="open-leave-request-btn" class="bg-blue-50 border border-blue-200 text-blue-800 p-6 rounded-lg shadow-sm hover:bg-blue-100 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <p class="text-lg font-semibold">សុំច្បាប់ឈប់</p>
                            <p class="text-sm">ឈប់សម្រាក</p>
                        </button>
                        <!-- Out Request -->
                        <button id="open-out-request-btn" class="bg-green-50 border border-green-200 text-green-800 p-6 rounded-lg shadow-sm hover:bg-green-100 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <p class="text-lg font-semibold">សុំច្បាប់ចេញក្រៅ</p>
                            <p class="text-sm">ចេញក្រៅផ្ទាល់ខ្លួន</p>
                        </button>
                    </div>
                </section>
                
                <!-- Approver Section -->
                <section class="mt-8">
                    <h3 class="text-md font-semibold text-gray-700 mb-3">អ្នកអនុញ្ញាតច្បាប់</h3>
                    <button class="w-full bg-white border border-gray-300 p-4 rounded-lg shadow-sm hover:bg-gray-50 transition-all flex items-center space-x-4">
                        <img src="https://i.postimg.cc/cL3wdGs8/photo-2025-09-27-15-47-14.jpg" alt="Approver" class="h-16 w-16 rounded-full border-2 border-white shadow-md object-cover">
                        <div>
                            <p class="text-lg font-semibold text-gray-800 text-left">លោកគ្រូ​ ពៅ ដារ៉ូ</p>
                            <p class="text-sm text-gray-500 text-left">គណៈគ្រប់គ្រង</p>
                        </div>
                    </button>
                </section>
            </div>

            <!-- ===== PAGE 2: ACCOUNT (គណនី) ===== -->
            <div id="page-account" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">គណនីរបស់ខ្ញុំ</h2>
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                    <div class="flex flex-col items-center">
                        <img id="user-photo" src="https://placehold.co/100x100/e2e8f0/64748b?text=User" alt="User Photo" class="h-24 w-24 rounded-full border-4 border-white shadow-lg mb-4 object-cover">
                        <h3 id="user-name" class="text-xl font-bold text-gray-900">...</h3>
                        <p id="user-id" class="text-sm text-gray-500">...</p>
                    </div>
                    <hr class="my-6 border-gray-200">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ភេទ:</span>
                            <span id="user-gender" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ក្រុម:</span>
                            <span id="user-group" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ផ្នែកការងារ:</span>
                            <span id="user-department" class="font-semibold text-gray-800">...</span>
                        </div>
                    </div>
                </div>
                <button id="logout-btn" class="w-full bg-red-500 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-150">
                    ចាកចេញពីគណនី
                </button>
            </div>

            <!-- ===== PAGE 3: HISTORY (ប្រវត្តិ) ===== -->
            <div id="page-history" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ប្រវត្តិសុំច្បាប់</h2>
                <p class="text-center text-sm text-gray-500 mb-6">បង្ហាញតែសំណើសម្រាប់ខែបច្ចុប្បន្នប៉ុណ្ណោះ</p>

                <!-- History Tabs -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="history-tab-leave" class="history-tab flex-1 py-3 text-center font-semibold">
                        ច្បាប់ឈប់សម្រាក
                    </button>
                    <button id="history-tab-out" class="history-tab flex-1 py-3 text-center font-semibold">
                        ច្បាប់ចេញក្រៅ
                    </button>
                </div>

                <!-- History Content -->
                <div id="history-content">
                    <!-- Leave History Container -->
                    <div id="history-container-leave">
                        <div id="history-placeholder-leave" class="text-center text-gray-500 mt-10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <p class="mt-4 text-lg">មិនទាន់មានប្រវត្តិ</p>
                        </div>
                        <!-- Leave cards injected here -->
                    </div>
                    <!-- Out History Container -->
                    <div id="history-container-out" class="hidden">
                        <div id="history-placeholder-out" class="text-center text-gray-500 mt-10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <p class="mt-4 text-lg">មិនទាន់មានប្រវត្តិ</p>
                        </div>
                        <!-- Out cards injected here -->
                    </div>
                </div>
            </div>

            <!-- ===== PAGE 4: HELP (ជំនួយ) ===== -->
            <div id="page-help" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ជំនួយ និង ទំនាក់ទំនង</h2>
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ក្រុមការងារ IT SUPPORT</h3>
                    <p class="text-gray-600 mb-4">ប្រសិនបើអ្នកជួបបញ្ហាក្នុងការប្រើប្រាស់កម្មវិធី សូមទាក់ទងមកក្រុមការងារយើងខ្ញុំតាមរយៈ៖</p>
                    <div class="space-y-4">
                        <a href="https://t.me/MMKDigitalIndustry" target="_blank" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" class="h-6 w-6">
                            <div class="ml-4">
                                <p class="font-semibold text-blue-600">Telegram</p>
                                <p class="text-sm text-gray-600">@MMKDigitalIndustry</p>
                            </div>
                        </a>
                        <a href="tel:090544452" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                            <div class="ml-4">
                                <p class="font-semibold text-green-700">លេខទូរស័ព្ទ</p>
                                <p class="text-sm text-gray-600">090 544 452</p>
                            </div>
                        </a>
                        <a href="mailto:perdigitalindustry@gmail.com" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                            <div class="ml-4">
                                <p class="font-semibold text-red-700">អ៊ីម៉ែល</p>
                                <p class="text-sm text-gray-600">perdigitalindustry@gmail.com</p>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-400">
                    <p>&copy; 2024 ឧស្សាហកម្មឌីជីថល</p>
                    <p>អភិវឌ្ឍន៍ដោយ ក្រុមការងារ IT SUPPORT</p>
                </div>
            </div>

            <!-- ===== PAGE 5: REQUEST LEAVE (ទម្រង់សុំច្បាប់ឈប់) ===== -->
            <div id="page-request-leave" class="p-6 hidden bg-gray-50">
                <header class="flex items-center mb-6">
                    <button id="cancel-leave-request-btn" class="p-2 text-gray-600 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800 text-center flex-grow">ទម្រង់សុំច្បាប់ឈប់សម្រាក</h2>
                    <div class="w-8"></div> <!-- Spacer -->
                </header>
                <section class="flex items-center bg-white border border-gray-200 p-4 rounded-lg shadow-sm mb-6">
                    <img id="request-leave-user-photo" src="https://placehold.co/60x60/e2e8f0/64748b?text=User" alt="User Photo" class="h-16 w-16 rounded-full border-2 border-white shadow-md object-cover">
                    <div class="ml-4">
                        <h3 id="request-leave-user-name" class="text-lg font-semibold text-gray-800">...</h3>
                        <p id="request-leave-user-id" class="text-sm text-gray-500">...</p>
                        <p id="request-leave-user-department" class="text-sm text-gray-500">...</p>
                    </div>
                </section>
                <section class="space-y-4 pb-24">
                    <div>
                        <label for="leave-duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                        <div class="relative">
                            <input type="text" id="leave-duration-search" placeholder="វាយ ឬ ជ្រើសរើសរយៈពេល..." class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                            <div id="leave-duration-dropdown" class="dropdown-list absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                        </div>
                    </div>
                    <div id="leave-single-date-container" class="hidden">
                        <label for="leave-date-single" class="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                        <input type="text" id="leave-date-single" disabled class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed">
                    </div>
                    <div id="leave-date-range-container" class="hidden space-y-4">
                        <div>
                            <label for="leave-date-start" class="block text-sm font-medium text-gray-700 mb-1">ចាប់ពីថ្ងៃ</label>
                            <input type="date" id="leave-date-start" disabled class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed">
                        </div>
                        <div>
                            <label for="leave-date-end" class="block text-sm font-medium text-gray-700 mb-1">ដល់ថ្ងៃ</label>
                            <input type="date" id="leave-date-end" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="leave-reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</label>
                        <div class="relative">
                            <input type="text" id="leave-reason-search" placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..." class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                            <div id="leave-reason-dropdown" class="dropdown-list absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                        </div>
                    </div>
                    <p id="leave-request-error" class="text-red-500 text-sm hidden"></p>
                    <div id="leave-request-loading" class="flex items-center justify-center text-gray-600 hidden">
                        <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <span>កំពុងដំណើរការ...</span>
                    </div>
                </section>
                <footer class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-200 max-w-md mx-auto">
                    <button id="submit-leave-request-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 disabled:opacity-50">
                        ស្នើសុំច្បាប់
                    </button>
                </footer>
            </div>
            
            <!-- ===== PAGE 6: REQUEST OUT (ទម្រង់សុំចេញក្រៅ) ===== -->
            <div id="page-request-out" class="p-6 hidden bg-gray-50">
                <header class="flex items-center mb-6">
                    <button id="cancel-out-request-btn" class="p-2 text-gray-600 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800 text-center flex-grow">ទម្រង់សុំច្បាប់ចេញក្រៅ</h2>
                    <div class="w-8"></div> <!-- Spacer -->
                </header>
                <section class="flex items-center bg-white border border-gray-200 p-4 rounded-lg shadow-sm mb-6">
                    <img id="request-out-user-photo" src="https://placehold.co/60x60/e2e8f0/64748b?text=User" alt="User Photo" class="h-16 w-16 rounded-full border-2 border-white shadow-md object-cover">
                    <div class="ml-4">
                        <h3 id="request-out-user-name" class="text-lg font-semibold text-gray-800">...</h3>
                        <p id="request-out-user-id" class="text-sm text-gray-500">...</p>
                        <p id="request-out-user-department" class="text-sm text-gray-500">...</p>
                    </div>
                </section>
                <section class="space-y-4 pb-24">
                    <div>
                        <label for="out-date-single" class="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                        <input type="text" id="out-date-single" disabled class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed">
                    </div>
                    <div>
                        <label for="out-duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                        <div class="relative">
                            <input type="text" id="out-duration-search" placeholder="វាយ ឬ ជ្រើសរើសរយៈពេល..." class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                            <div id="out-duration-dropdown" class="dropdown-list absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                        </div>
                    </div>
                    <div>
                        <label for="out-reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</label>
                        <div class="relative">
                            <input type="text" id="out-reason-search" placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..." class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                            <div id="out-reason-dropdown" class="dropdown-list absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                        </div>
                    </div>
                    <p id="out-request-error" class="text-red-500 text-sm hidden"></p>
                    <div id="out-request-loading" class="flex items-center justify-center text-gray-600 hidden">
                        <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <span>កំពុងដំណើរការ...</span>
                    </div>
                </section>
                <footer class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-200 max-w-md mx-auto">
                    <button id="submit-out-request-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 disabled:opacity-50">
                        ស្នើសុំច្បាប់
                    </button>
                </footer>
            </div>

        </main>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-navigation" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-16 bg-white border-t border-gray-200 shadow-md flex justify-around items-center">
            <button class="nav-btn p-2 text-blue-600" data-page="page-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                <span class="text-xs font-medium">ទំព័រដើម</span>
            </button>
            <button class="nav-btn p-2 text-gray-500" data-page="page-history">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-xs font-medium">ប្រវត្តិ</span>
            </button>
            <button class="nav-btn p-2 text-gray-500" data-page="page-account">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                <span class="text-xs font-medium">គណនី</span>
            </button>
            <button class="nav-btn p-2 text-gray-500" data-page="page-help">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                <span class="text-xs font-medium">ជំនួយ</span>
            </button>
        </nav>
    </div>

    <!-- ===== Edit Modal ===== -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
            <h3 id="edit-modal-title" class="text-xl font-bold mb-4">កែសម្រួលសំណើ</h3>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-request-id">
                
                <!-- Simplified Edit: Just Reason -->
                <div>
                    <label for="edit-reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</label>
                    <div class="relative">
                        <input type="text" id="edit-reason-search" placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..." class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                        <div id="edit-reason-dropdown" class="dropdown-list absolute z-30 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden"></div>
                    </div>
                </div>
                
                <!-- NOTE: Duration and Date fields are hidden for simplicity of Edit -->
                <!-- A full implementation would require re-populating and re-validating them -->
                <div id="edit-duration-search-container" class="hidden">
                    <label for="edit-duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                    <div class="relative">
                        <input type="text" id="edit-duration-search" class="w-full px-4 py-3 border border-gray-300 rounded-lg" autocomplete="off">
                        <div id="edit-duration-dropdown" class="dropdown-list absolute z-30 w-full mt-1 bg-white border ..."></div>
                    </div>
                </div>
                <div id="edit-single-date-container" class="hidden">
                    <label for="edit-leave-date-single" class="block text-sm ...">កាលបរិច្ឆេទ</label>
                    <input type="text" id="edit-leave-date-single" class="w-full ...">
                </div>
                <div id="edit-date-range-container" class="hidden space-y-4">
                     <label for="edit-leave-date-start" class="block text-sm ...">ចាប់ពីថ្ងៃ</label>
                    <input type="date" id="edit-leave-date-start" class="w-full ...">
                    <label for="edit-leave-date-end" class="block text-sm ...">ដល់ថ្ងៃ</label>
                    <input type="date" id="edit-leave-date-end" class="w-full ...">
                </div>


                <p id="edit-error" class="text-red-500 text-sm hidden"></p>
                <div id="edit-loading" class="flex items-center justify-center text-gray-600 hidden">
                    <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                    <span>កំពុងដំណើរការ...</span>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancel-edit-btn" type="button" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                        បោះបង់
                    </button>
                    <button id="submit-edit-btn" type="button" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700">
                        រក្សាទុកការកែប្រែ
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ===== Delete Modal ===== -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
            <input type="hidden" id="delete-request-id">
            <input type="hidden" id="delete-collection-type">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="text-xl font-bold mt-4 mb-2">លុបសំណើ?</h3>
            <p class="text-gray-600 mb-6">តើអ្នកពិតជាចង់លុបសំណើនេះមែនទេ? សកម្មភាពនេះ មិនអាចបកក្រោយបានទេ។</p>
            <div class="flex justify-center space-x-3">
                <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300">
                    បោះបង់
                </button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white py-2 px-5 rounded-lg font-semibold shadow-md hover:bg-red-700">
                    យល់ព្រមលុប
                </button>
            </div>
        </div>
    </div>
  <div id="return-scan-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md text-center">
            <h3 class="text-xl font-bold mb-4">បញ្ជាក់ការចូលមកវិញ</h3>
            
            <div id="return-video-container" class="">
                <div class="relative w-full h-64 bg-gray-800 rounded-lg overflow-hidden border-4 border-blue-500">
                    <video id="return-video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                </div>
            </div>

            <p id="return-scan-status" class="mt-4 text-lg font-medium text-gray-700 h-12">...</p>
            <p id="return-scan-debug" class="text-xs text-gray-500 h-4"></p>

            <button id="cancel-return-scan-btn" class="mt-4 w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                បោះបង់
            </button>
        </div>
    </div>
    <div id="custom-alert-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
            <svg id="custom-alert-icon-warning" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <svg id="custom-alert-icon-success" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            
            <h3 id="custom-alert-title" class="text-xl font-bold mt-4 mb-2">...</h3>
            <p id="custom-alert-message" class="text-gray-600 mb-6 whitespace-pre-line">...</p> 
            <div class="flex justify-center">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white py-2 px-8 rounded-lg font-semibold shadow-md hover:bg-blue-700">
                    យល់ព្រម
                </button>
            </div>
        </div>
    </div>

</body>
</html>


